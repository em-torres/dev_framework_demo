# AI-SDLC Framework v3.2.1 - Enhanced CI/CD Pipeline
# Enterprise-grade CI/CD with comprehensive quality gates
# Generated by AI-SDLC Framework

name: ðŸš€ Enhanced CI/CD Pipeline

on:
  push:
    branches: [main, master, develop, staging]
    tags: ['v*']
  pull_request:
    branches: [main, master]
    types: [opened, synchronize, reopened, ready_for_review]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production
      skip_tests:
        description: 'Skip test execution'
        required: false
        default: false
        type: boolean

env:
  NODE_VERSION: '18'
  CACHE_VERSION: v1
  SONAR_ORGANIZATION: thecreditpros
  REGISTRY: ghcr.io

permissions:
  contents: read
  packages: write
  security-events: write
  actions: read
  checks: write
  pull-requests: write
  issues: write

jobs:
  # ============================================================================
  # SETUP & VALIDATION
  # ============================================================================
  setup:
    name: ðŸ”§ Setup & Validation
    runs-on: ubuntu-latest
    outputs:
      cache-key: ${{ steps.cache-keys.outputs.cache-key }}
      should-deploy: ${{ steps.deploy-check.outputs.should-deploy }}
      environment: ${{ steps.deploy-check.outputs.environment }}
      version: ${{ steps.version.outputs.version }}
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ Generate Cache Keys
        id: cache-keys
        run: |
          echo "cache-key=node-modules-${{ env.CACHE_VERSION }}-${{ hashFiles('**/package-lock.json') }}" >> $GITHUB_OUTPUT

      - name: ðŸ“¦ Cache Dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.npm
            node_modules
            .eslintcache
          key: ${{ steps.cache-keys.outputs.cache-key }}
          restore-keys: |
            node-modules-${{ env.CACHE_VERSION }}-

      - name: ðŸ“¦ Install Dependencies
        run: npm ci --prefer-offline --no-audit

      - name: ðŸ” Validate Package Structure
        run: |
          npm run validate || echo "Validation script not found, skipping..."
          node -e "console.log('Package validation complete')"

      - name: ðŸ“‹ Deployment Check
        id: deploy-check
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "should-deploy=true" >> $GITHUB_OUTPUT
            echo "environment=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == "refs/heads/main" || "${{ github.ref }}" == "refs/heads/master" ]]; then
            echo "should-deploy=true" >> $GITHUB_OUTPUT
            echo "environment=production" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == "refs/heads/develop" || "${{ github.ref }}" == "refs/heads/staging" ]]; then
            echo "should-deploy=true" >> $GITHUB_OUTPUT
            echo "environment=staging" >> $GITHUB_OUTPUT
          else
            echo "should-deploy=false" >> $GITHUB_OUTPUT
            echo "environment=none" >> $GITHUB_OUTPUT
          fi

      - name: ðŸ·ï¸ Extract Version
        id: version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          else
            echo "version=$(node -p "require('./package.json').version")-${{ github.sha }}" >> $GITHUB_OUTPUT
          fi

  # ============================================================================
  # CODE QUALITY & SECURITY
  # ============================================================================
  quality-gates:
    name: ðŸ” Quality Gates
    runs-on: ubuntu-latest
    needs: setup
    strategy:
      matrix:
        check: [lint, type-check, security-scan]
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ Restore Dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.npm
            node_modules
            .eslintcache
          key: ${{ needs.setup.outputs.cache-key }}

      - name: ðŸ“¦ Install Dependencies
        run: npm ci --prefer-offline --no-audit

      - name: ðŸ” ESLint Check
        if: matrix.check == 'lint'
        run: |
          npm run lint
          npm run format -- --check

      - name: ðŸ” TypeScript Check
        if: matrix.check == 'type-check'
        run: npm run type-check

      - name: ðŸ”’ Security Scan
        if: matrix.check == 'security-scan'
        run: |
          npm audit --audit-level=moderate
          npx audit-ci --moderate

      - name: ðŸ“Š Upload ESLint Results
        if: matrix.check == 'lint' && always()
        uses: github/super-linter@v4
        env:
          DEFAULT_BRANCH: main
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VALIDATE_JAVASCRIPT_ES: true
          VALIDATE_TYPESCRIPT_ES: true

  # ============================================================================
  # COMPREHENSIVE TESTING
  # ============================================================================
  test-suite:
    name: ðŸ§ª Test Suite
    runs-on: ubuntu-latest
    needs: setup
    if: github.event.inputs.skip_tests != 'true'
    strategy:
      matrix:
        test-type: [unit, integration, e2e]
        node-version: [18, 20]
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: ðŸ“¦ Restore Dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.npm
            node_modules
            .eslintcache
          key: ${{ needs.setup.outputs.cache-key }}

      - name: ðŸ“¦ Install Dependencies
        run: npm ci --prefer-offline --no-audit

      - name: ðŸ§ª Unit Tests
        if: matrix.test-type == 'unit'
        run: |
          npm run test:unit
          npm run test:coverage

      - name: ðŸ”— Integration Tests
        if: matrix.test-type == 'integration'
        run: npm run test:smart

      - name: ðŸŽ­ E2E Tests
        if: matrix.test-type == 'e2e'
        run: |
          npx playwright install --with-deps
          npm run test:e2e

      - name: ðŸ“Š Upload Coverage Reports
        if: matrix.test-type == 'unit' && matrix.node-version == '18'
        uses: codecov/codecov-action@v3
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./coverage/lcov.info
          flags: unittests
          name: codecov-umbrella

      - name: ðŸ“Š Upload Test Results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: test-results-${{ matrix.test-type }}-node${{ matrix.node-version }}
          path: |
            coverage/
            test-results/
            playwright-report/

  # ============================================================================
  # SONARCLOUD ANALYSIS
  # ============================================================================
  sonarcloud:
    name: ðŸ“Š SonarCloud Analysis
    runs-on: ubuntu-latest
    needs: [setup, test-suite]
    if: always() && (needs.test-suite.result == 'success' || needs.test-suite.result == 'skipped')
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ Restore Dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.npm
            node_modules
            .eslintcache
          key: ${{ needs.setup.outputs.cache-key }}

      - name: ðŸ“¦ Install Dependencies
        run: npm ci --prefer-offline --no-audit

      - name: ðŸ“Š Download Coverage Reports
        uses: actions/download-artifact@v3
        with:
          name: test-results-unit-node18
          path: ./

      - name: ðŸ“Š SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          args: >
            -Dsonar.organization=${{ env.SONAR_ORGANIZATION }}
            -Dsonar.projectKey=${{ env.SONAR_ORGANIZATION }}_${{ github.event.repository.name }}
            -Dsonar.javascript.lcov.reportPaths=coverage/lcov.info
            -Dsonar.coverage.exclusions=**/*.test.js,**/*.spec.js,**/*.test.ts,**/*.spec.ts,**/node_modules/**
            -Dsonar.sources=src
            -Dsonar.tests=tests,__tests__,src/**/*.test.js,src/**/*.spec.js
            -Dsonar.projectVersion=${{ needs.setup.outputs.version }}

  # ============================================================================
  # SECURITY SCANNING
  # ============================================================================
  security-analysis:
    name: ðŸ”’ Security Analysis
    runs-on: ubuntu-latest
    needs: setup
    permissions:
      security-events: write
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸ”’ CodeQL Analysis
        uses: github/codeql-action/init@v2
        with:
          languages: javascript

      - name: ðŸ”’ Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v2

      - name: ðŸ”’ Dependency Vulnerability Scan
        uses: actions/dependency-review-action@v3
        if: github.event_name == 'pull_request'

  # ============================================================================
  # BUILD & PACKAGE
  # ============================================================================
  build:
    name: ðŸ—ï¸ Build & Package
    runs-on: ubuntu-latest
    needs: [setup, quality-gates]
    if: always() && needs.quality-gates.result == 'success'
    outputs:
      image-digest: ${{ steps.build.outputs.digest }}
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ Restore Dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.npm
            node_modules
            .eslintcache
          key: ${{ needs.setup.outputs.cache-key }}

      - name: ðŸ“¦ Install Dependencies
        run: npm ci --prefer-offline --no-audit

      - name: ðŸ—ï¸ Build Application
        run: npm run build

      - name: ðŸ“¦ Create Build Artifact
        uses: actions/upload-artifact@v3
        with:
          name: build-${{ needs.setup.outputs.version }}
          path: |
            dist/
            build/
            public/
          retention-days: 30

  # ============================================================================
  # DEPLOYMENT
  # ============================================================================
  deploy:
    name: ðŸš€ Deploy to ${{ needs.setup.outputs.environment }}
    runs-on: ubuntu-latest
    needs: [setup, test-suite, build, sonarcloud]
    if: needs.setup.outputs.should-deploy == 'true' && always() && needs.build.result == 'success'
    environment:
      name: ${{ needs.setup.outputs.environment }}
      url: ${{ steps.deploy.outputs.url }}
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸ“¦ Download Build Artifact
        uses: actions/download-artifact@v3
        with:
          name: build-${{ needs.setup.outputs.version }}
          path: ./dist

      - name: ðŸš€ Deploy Application
        id: deploy
        run: |
          echo "Deploying to ${{ needs.setup.outputs.environment }}"
          echo "Version: ${{ needs.setup.outputs.version }}"
          # Add your deployment logic here
          echo "url=https://${{ needs.setup.outputs.environment }}.example.com" >> $GITHUB_OUTPUT

      - name: ðŸ”” Deployment Notification
        if: always()
        env:
          MS_TEAMS_WEBHOOK_URI: ${{ secrets.MS_TEAMS_WEBHOOK_URI }}
        run: |
          if [[ -n "$MS_TEAMS_WEBHOOK_URI" ]]; then
            curl -H "Content-Type: application/json" -d '{
              "@type": "MessageCard",
              "@context": "http://schema.org/extensions",
              "themeColor": "'${{ job.status == 'success' && '28a745' || 'dc3545' }}'",
              "summary": "ðŸš€ AI-SDLC Framework Deployment",
              "sections": [{
                "activityTitle": "Deployment to ${{ needs.setup.outputs.environment }}",
                "activitySubtitle": "Version ${{ needs.setup.outputs.version }}",
                "facts": [
                  {"name": "Repository", "value": "${{ github.repository }}"},
                  {"name": "Environment", "value": "${{ needs.setup.outputs.environment }}"},
                  {"name": "Version", "value": "${{ needs.setup.outputs.version }}"},
                  {"name": "Status", "value": "${{ job.status }}"},
                  {"name": "Triggered by", "value": "${{ github.actor }}"}
                ]
              }],
              "potentialAction": [{
                "@type": "OpenUri",
                "name": "View Deployment",
                "targets": [{"os": "default", "uri": "${{ steps.deploy.outputs.url }}"}]
              }]
            }' "$MS_TEAMS_WEBHOOK_URI"
          fi

  # ============================================================================
  # POST-DEPLOYMENT VALIDATION
  # ============================================================================
  post-deploy-validation:
    name: âœ… Post-Deployment Validation
    runs-on: ubuntu-latest
    needs: [setup, deploy]
    if: needs.deploy.result == 'success'
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ðŸ§ª Smoke Tests
        run: |
          echo "Running smoke tests against ${{ needs.setup.outputs.environment }}"
          # Add smoke test logic here
          curl -f "${{ needs.deploy.outputs.url }}/health" || exit 1

      - name: ðŸ“Š Performance Tests
        run: |
          echo "Running performance tests"
          # Add performance test logic here

  # ============================================================================
  # CLEANUP
  # ============================================================================
  cleanup:
    name: ðŸ§¹ Cleanup
    runs-on: ubuntu-latest
    needs: [setup, deploy, post-deploy-validation]
    if: always()
    steps:
      - name: ðŸ§¹ Clean up artifacts
        uses: actions/github-script@v6
        with:
          script: |
            const artifacts = await github.rest.actions.listWorkflowRunArtifacts({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: context.runId,
            });

            // Keep only the latest 5 artifacts
            const oldArtifacts = artifacts.data.artifacts
              .sort((a, b) => new Date(b.created_at) - new Date(a.created_at))
              .slice(5);

            for (const artifact of oldArtifacts) {
              await github.rest.actions.deleteArtifact({
                owner: context.repo.owner,
                repo: context.repo.repo,
                artifact_id: artifact.id,
              });
            }
